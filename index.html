<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Quiz Offline Hoàn Chỉnh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.8.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        :root {
            --primary-bg: #f4f6f9;
            --secondary-bg: #ffffff;
            --text-color: #212529;
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8; /* MÀU MỚI */
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow-y: auto;
            max-height: 95vh;
        }
        .screen { display: none; }
        .screen.active { display: block; }
        h1, h2, h3 { text-align: center; color: var(--primary-color); }
        textarea {
            width: 100%;
            height: 250px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            box-sizing: border-box;
            margin-bottom: 15px;
            overflow-y: auto;
        }
        .button-group { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 20px; }
        .btn {
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: var(--primary-color);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
        }
        .btn:hover { background-color: #0056b3; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #c82333; }
        .btn-warning { background-color: var(--warning-color); }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: #218838; }
        .btn-info { background-color: var(--info-color); }
        .btn-info:hover { background-color: #138496; }

        .output-box {
            background-color: #fdfdfd; border-radius: 8px; padding: 15px;
            border: 1px solid #eee; margin-top: 10px; min-height: 300px;
        }
        #visual-review-output { font-size: 16px; white-space: pre-wrap; word-wrap: break-word; line-height: 1.8; }
        .legend {
            border: 1px solid #ccc; padding: 10px; border-radius: 8px;
            margin-top: 20px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;
        }
        .legend-item { display: flex; align-items: center; font-size: 14px; }
        .legend-color { width: 20px; height: 20px; border: 1px solid #999; margin-right: 8px; }
        .ignored { background-color: #ffcccc; }
        .question { background-color: #ff9933; color: black; padding: 1px 3px; border-radius: 3px;}
        .correct-answer { background-color: #28a745; color: white; padding: 1px 3px; border-radius: 3px;}
        .incorrect-answer { background-color: #ffd700; color: black; padding: 1px 3px; border-radius: 3px;}
        .question-chunk {
            display: block; border: 1px dotted #ccc;
            padding: 10px; margin-bottom: 10px; border-radius: 4px;
        }

        .warning-collapsed {
            padding: 10px 15px;
            background-color: var(--warning-color);
            color: #333;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            margin-bottom: 20px;
            transition: background-color 0.2s;
        }
        .warning-collapsed:hover {
            background-color: #e0a800;
        }
        .warning-details {
            border: 2px solid var(--danger-color);
            padding: 15px;
            border-radius: 5px;
            background-color: #fff5f5;
            margin-bottom: 20px;
        }
        .question-container { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .options-container label { display: block; margin-bottom: 10px; padding: 8px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .options-container label:hover { background-color: #f0f0f0; }
        .question-text { font-size: 18px; margin-bottom: 5px; font-weight: bold; }
        .sidebar { width: 260px; max-height: 80vh; overflow-y: auto; position: fixed; top: 0; left: 0; height: 100%; background-color: var(--secondary-bg); box-shadow: var(--box-shadow); transition: transform 0.3s ease; }
        .pill-container { display: flex; flex-wrap: wrap; gap: 8px; padding: 8px; }
        .main-content { transition: all 0.3s ease; padding: 15px; }
        .with-sidebar { margin-left: 260px; width: calc(100% - 260px); }
        .full { margin-left: 0; width: 100%; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; }
        .modal-content { background-color: var(--secondary-bg); margin: 5% auto; padding: 20px; border-radius: var(--border-radius); width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: var(--box-shadow); position: relative; }
        #statisticsModal .modal-content { max-width: 500px; }
        .modal-content.large-search-open { margin-top: 0.5%; padding-top: 150px; }
        .comparison-question { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #ccc; }
        .comparison-question:last-of-type { border-bottom: none; }
        .comparison-question-text { margin-bottom: 15px; white-space: pre-wrap; }
        .options-comparison-wrapper { display: flex; flex-direction: row; gap: 15px; }
        .options-column { flex: 1; min-width: 48%; border: 1px solid #e0e0e0; border-radius: var(--border-radius); padding: 10px; background-color: #fdfdfd; }
        .options-column h5 { margin-top: 0; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; font-size: 16px; }
        .option-item { padding: 4px; margin: 3px 0; border-radius: 4px; }
        #comparison-menu-btn { position: fixed; top: 20px; right: 20px; width: 40px; height: 40px; background-color: var(--primary-color); border-radius: 50%; cursor: pointer; z-index: 1002; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #comparison-menu-btn .bar { width: 20px; height: 2px; background-color: white; transition: all 0.3s; }
        .search-menu { background-color: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1001; box-sizing: border-box; position: absolute; }
        .search-menu h4 { margin-top: 0; color: var(--primary-color); }
        .search-menu .input-group { margin-bottom: 15px; display: flex; align-items: center; }
        .search-menu .input-group label { width: 60px; }
        .search-menu input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .search-menu .icon-btn { background: none; border: none; cursor: pointer; font-size: 24px; }
        .search-menu .clear-btn { border: 1px solid #ccc; border-radius: 4px; padding: 2px 8px; cursor: pointer; }
        #small-search-menu { top: 65px; right: 20px; width: 300px; height: auto; padding: 15px; border-radius: var(--border-radius); transform-origin: top right; transition: transform 0.2s ease-out, opacity 0.2s; transform: scale(0.95); opacity: 0; pointer-events: none; }
        #small-search-menu.open { transform: scale(1); opacity: 1; pointer-events: auto; }
        #large-search-menu { top: 0; left: 0; width: 100%; height: auto; display: flex; flex-direction: column; padding: 15px 65px 15px 15px; border-bottom: 1px solid #eee; transition: transform 0.3s ease-in-out; transform: translateY(-110%); }
        #large-search-menu.open { transform: translateY(0); }
        #large-search-menu .search-controls { display: flex; width: 100%; gap: 10px; align-items: center; margin-top: 45px; }
        #large-search-menu .input-group { flex: 1; margin-bottom: 0; }
        #large-search-results { font-weight: bold; color: var(--success-color); margin-top: 10px; }
        .nav-buttons { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        mark { background-color: #ffc107; padding: 0 2px; }
        .fixed-btn { position: fixed; bottom: 30px; right: 30px; padding: 15px 25px; font-size: 18px; font-weight: bold; color: white; background-color: var(--success-color); border: none; border-radius: 50px; cursor: pointer; text-align: center; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 999; }
        .fixed-btn:hover { background-color: #218838; transform: scale(1.05); }
        #comparison-help-btn { position: fixed; top: 20px; left: 20px; width: 40px; height: 40px; background-color: var(--secondary-color); border-radius: 50%; cursor: pointer; z-index: 1002; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #helpModal .modal-content ul { list-style-type: none; padding: 0; }
        #helpModal .modal-content li { margin-bottom: 15px; line-height: 1.6; }
        #helpModal .modal-content .icon { display: inline-block; width: 20px; text-align: center; margin-right: 10px; }
        #statistics-legend { margin-top: 15px; font-size: 16px; line-height: 1.6; text-align: center; border-top: 1px solid #eee; padding-top: 15px; }
        #statistics-chart { min-height: 300px; color: #333; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">
    <div id="loading-screen" class="modal" style="display: none; justify-content: center; align-items: center; background-color: rgba(0, 0, 0, 0.3);">
        <div style="background: white; padding: 25px 50px; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
            <h3 style="margin-top: 0;">Đang xử lý...</h3>
            <p>Vui lòng đợi trong giây lát.</p>
        </div>
    </div>

    <div class="container">
        <div id="home-screen" class="screen active">
            <h1>Quiz Offline</h1>
            <div class="button-group">
                <button class="btn" onclick="showScreen('input-screen')">Tạo Đề Thi Mới</button>
                <button class="btn btn-secondary" onclick="showScreen('saved-list-screen')">Xem Bài Đã Lưu</button>
                <button class="btn btn-secondary" onclick="showScreen('history-list-screen')">Xem Lịch Sử Làm Bài</button>
                <button class="btn btn-secondary" id="import-quiz-btn">Nhập Bài Thi</button>
                <button class="btn btn-secondary" id="check-quota-btn">Kiểm Tra Dung Lượng</button>
                <button class="btn btn-danger" id="clear-all-data-btn">Xóa Sạch Dữ Liệu</button>
            </div>
        </div>

        <div id="input-screen" class="screen">
            <h2>Nhập Nội Dung Bài Thi</h2>
            <textarea id="manual-input" placeholder="Dán nội dung vào đây..."></textarea>
            <p style="color: #666; font-size: 14px; text-align: left; line-height: 1.6;">
                <b>Định dạng:</b> Gói các câu hỏi trong cặp thẻ tương ứng.<br>
                <b>1. Trả lời ngắn (dùng dấu * hoặc "đáp án:"):</b><br>
                <code style="background: #e9e9e9; padding: 1px 4px; border-radius: 3px;">#*trả*#Câu hỏi? *Câu trả lời#*trả*#</code><br>
                <b>2. Trắc nghiệm (đáp án đúng bắt đầu bằng dấu *):</b><br>
                <code style="background: #e9e9e9; padding: 1px 4px; border-radius: 3px;">#*trắc*#Nội dung câu hỏi<br>A. Đáp án sai<br>*B. Đáp án đúng#*trắc*#</code><br>
                <b>3. Trắc nghiệm nhiều đáp án (dùng #*dòng*#):</b><br>
                <code style="background: #e9e9e9; padding: 1px 4px; border-radius: 3px;">#*trắc*#Câu hỏi<br>#*dòng*#<br>*Đáp án đúng 1<br>Đáp án sai 2#*trắc*#</code>
            </p>
            <div class="button-group">
                <input type="file" id="docx-upload" accept=".docx" style="margin-bottom: 10px;">
                <button id="create-quiz-btn" class="btn btn-success">Tạo & Soát Lỗi</button>
                 <button class="btn btn-secondary" onclick="showScreen('home-screen')">Quay Lại</button>
            </div>
        </div>

        <div id="review-screen" class="screen">
            <h2>Soát Lỗi & Xem Lại</h2>
            
            <div class="button-group" style="margin-bottom: 20px;">
                 <button class="btn" onclick="prepareQuizUI(appState.currentQuiz, true)">Bắt Đầu Làm Bài Ngay</button>
            </div>

            <div id="review-warnings-container"></div>
            
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #ffcccc;"></div><span>Bị bỏ qua</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #ff9933;"></div><span>Câu hỏi</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #28a745;"></div><span>Đáp án đúng</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #ffd700;"></div><span>Đáp án sai</span></div>
            </div>
            <div id="visual-review-output" class="output-box"></div>
            <div class="button-group" style="margin-top: 20px; grid-template-columns: 1fr 1fr;">
                <button class="btn btn-secondary" onclick="showScreen('input-screen')">Quay Lại Sửa</button>
                <button class="btn btn-primary" onclick="prepareQuizUI(appState.currentQuiz, true)">Bắt Đầu Làm Bài</button>
            </div>
        </div>
        
        <div id="saved-list-screen" class="screen">
            <div id="sidebar" class="sidebar">
                <div class="p-4 font-bold">📑 Bài Thi Đã Lưu</div>
                <div id="saved-quizzes-list" class="pill-container"></div>
                 <button class="btn btn-secondary m-2" onclick="showScreen('home-screen')">Về Trang Chủ</button>
            </div>
            <div id="mainContent" class="main-content with-sidebar">
                <h1 class="text-2xl font-bold mb-4">Danh sách bài thi</h1>
                <p class="text-gray-600">👉 Chọn một hoặc nhiều bài thi để bắt đầu.</p>
                <div id="questionBox" class="mt-6 p-4 bg-white rounded-xl shadow max-w-md hidden text-left space-y-4"></div>
                <button id="exportQuizBtn" class="btn btn-secondary">Xuất Bài Thi</button>
            </div>
            <div id="contentModal" class="modal">
                <div id="contentModalContent" class="modal-content">
                    <h3 id="modalTitle"></h3>
                    <div id="modalContent"></div>
                    <div class="button-group mt-4">
                        <button class="btn btn-secondary" onclick="closeModal()">Quay lại</button>
                        <button id="startFromModalBtn" class="btn" style="display:none;"></button>
                        <button class="btn btn-danger" id="deleteQuizBtn">Xóa</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="history-list-screen" class="screen">
            <div id="history-sidebar" class="sidebar">
                <div class="p-4 font-bold">📜 Lịch Sử Làm Bài</div>
                <div id="history-list" class="pill-container"></div>
                <button class="btn btn-secondary m-2" onclick="showScreen('home-screen')">Về Trang Chủ</button>
            </div>
            <div id="history-mainContent" class="main-content with-sidebar">
                <h1 class="text-2xl font-bold mb-4">Danh sách lịch sử làm bài</h1>
                <p class="text-gray-600">👉 Vuốt sang trái để ẩn sidebar, vuốt sang phải để mở lại.</p>
                <div id="history-questionBox" class="mt-6 p-4 bg-white rounded-xl shadow max-w-md hidden text-left space-y-4"></div>
            </div>
            <div id="history-contentModal" class="modal">
                <div id="history-contentModalContent" class="modal-content">
                    <h3 id="history-modalTitle"></h3>
                    <div id="history-modalContent"></div>
                    <div class="button-group mt-4">
                        <button class="btn btn-secondary" onclick="closeHistoryModal()">Quay lại</button>
                        <button class="btn btn-danger" id="deleteHistoryBtn">Xóa</button>
                    </div>
                </div>
            </div>
            
            <div id="statisticsModal" class="modal">
                <div class="modal-content">
                    <button id="statistics-close-btn" style="position: absolute; top: 15px; right: 15px; width: 30px; height: 30px; border: none; background: #eee; border-radius: 50%; font-weight: bold; cursor: pointer;">X</button>
                    <h3 id="statistics-modalTitle" style="text-align: center;">Thống kê kết quả</h3>
                    <div id="statistics-content">
                        <div id="statistics-chart"></div>
                        <div id="statistics-legend"></div>
                    </div>
                </div>
            </div>

            <div id="comparisonModal" class="modal">
                <div class="modal-content">
                    <button id="comparison-help-btn" style="display: none;">?</button>
                    
                    <div id="comparison-menu-btn" style="display: none;">
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                    </div>
                    
                    <h3 id="comparison-modalTitle"></h3>
                    <div id="comparison-content"></div>
                    <div class="button-group mt-4">
                        <button class="btn btn-secondary" onclick="closeComparisonModal()">Quay lại</button>
                    </div>
                </div>
                
                <div id="small-search-menu" class="search-menu">
                    <h4>Tìm Câu Nhanh</h4>
                    <div class="input-group">
                        <label for="dao-input">Đảo</label>
                        <input type="number" id="dao-input" placeholder="Số đã đảo...">
                    </div>
                    <div class="input-group">
                        <label for="thuan-input">Thuận</label>
                        <input type="number" id="thuan-input" placeholder="Số gốc...">
                    </div>
                    <div class="input-group" style="justify-content: flex-end; margin-bottom: 0;">
                        <span class="clear-btn" id="clear-small-search">xóa</span>
                        <button class="icon-btn" id="exec-small-search">🔎</button>
                    </div>
                </div>
                
                <div id="large-search-menu" class="search-menu">
                    <div class="search-controls">
                        <span class="clear-btn" id="clear-large-search">xóa</span>
                        <div class="input-group">
                           <input type="text" id="large-search-input" placeholder="Nhập nội dung cần tìm...">
                        </div>
                        <button class="icon-btn" id="exec-large-search">🔎</button>
                    </div>
                     <div id="large-search-results"></div>
                    <div class="nav-buttons">
                        <button class="btn btn-secondary" id="prev-match-btn">Quay lại</button>
                        <button class="btn btn-secondary" id="next-match-btn">Kế tiếp</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="quiz-section" class="screen">
            <h2 id="quiz-title">Nội dung bài thi</h2>
            <div id="quiz-live-container"></div>
            <div id="results-container" style="display:none;">
                <h2>Kết Quả</h2>
                <p id="final-score"></p>
            </div>
            <div class="button-group">
                <button id="start-btn" class="btn" style="display:none;"></button>
                <button id="shuffle-btn" class="btn" style="display:none;">Trộn câu hỏi và đáp án: Tắt</button>
                <button id="save-btn" class="btn btn-secondary" style="display:none;">Lưu Bài Này</button>
                <button id="submit-early-btn" class="btn btn-warning" style="display:none;">Nộp Bài Sớm</button>
                 <button class="btn btn-danger" onclick="showScreen('home-screen')">Thoát</button>
            </div>
        </div>
        <button id="startQuizBtn" class="fixed-btn" style="display:none;">Bắt Đầu Làm Bài</button>
    </div>
    
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <h3>Trợ giúp & Hướng dẫn</h3>
            <ul>
                <li>
                    <span class="icon">🎨</span>
                    <strong>Màu nền giống nhau:</strong> Các đáp án có cùng màu nền ở cột "gốc" và cột "xáo trộn" là cùng một đáp án, giúp bạn nhận biết thứ tự đã bị thay đổi như thế nào.
                </li>
                 <li>
                    <span class="icon" style="color: var(--success-color); font-weight: bold;">■</span>
                    <strong style="color: var(--success-color);">Chữ Xanh Lá & In Đậm:</strong> Là đáp án đúng mà bạn đã chọn đúng.
                </li>
                 <li>
                    <span class="icon" style="color: var(--success-color);">■</span>
                    <span style="color: var(--success-color); text-decoration: underline;">Chữ Xanh Lá & Gạch chân:</span> Là đáp án đúng bạn đã bỏ sót.
                </li>
                 <li>
                    <span class="icon" style="color: var(--danger-color);">■</span>
                    <strong style="color: var(--danger-color);">Chữ Đỏ:</strong> Là đáp án sai mà bạn đã chọn.
                </li>
                 <li>
                    <span class="icon">☰</span>
                    <strong>Menu tìm kiếm (góc trên bên phải):</strong>
                    <ul style="margin-left: 30px; margin-top: 10px; list-style-type: disc;">
                        <li><strong>Nhấn nhanh:</strong> Mở menu tìm kiếm nhanh theo số thứ tự câu hỏi (gốc hoặc đã đảo).</li>
                        <li><strong>Nhấn giữ:</strong> Mở thanh tìm kiếm lớn ở trên cùng để tìm theo nội dung văn bản.</li>
                    </ul>
                </li>
            </ul>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="document.getElementById('helpModal').style.display='none'">Đã hiểu</button>
            </div>
        </div>
    </div>
    
    <script>
        const optionMarkerRegex = /(?<=(?:^|\n|\t|[*.?]\s*))\*?\s*[A-Za-z]{1,2}[.)]/g;
        const optionPrefixRegex = /^\s*\*?\s*[A-Za-z]{1,2}[.)]/;
        
        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        const pillColorConfig = {
            baseClasses: 'px-4 py-2 rounded-full text-white font-semibold shadow-md transition-transform transform hover:scale-105',
            selectedClasses: 'bg-gray-500 hover:bg-gray-600',
            colors: [
                { name: 'blue', classes: 'bg-blue-500 hover:bg-blue-600' },
                { name: 'green', classes: 'bg-green-500 hover:bg-green-600' },
                { name: 'purple', classes: 'bg-purple-500 hover:bg-purple-600' }
            ]
        };

        let appState = {
            currentQuiz: [],
            currentWarnings: [],
            originalQuizOrder: [],
            shuffledQuizMap: [],
            shuffledOptionsMap: [],
            currentQuestionIndex: 0,
            score: 0,
            isShuffled: false,
            selectedQuizzes: new Set(),
            currentModalQuiz: null,
            userAnswers: [],
            currentModalHistory: null,
            isQuizStarted: false,
            currentScreen: 'home-screen',
            lastScreen: 'home-screen',
            isPopping: false
        };

        const APEX_LIB_KEY = 'apexChartsLibraryCode_v2';
        const APEX_CDN_URL = 'https://cdn.jsdelivr.net/npm/apexcharts';
        
        const DOCX_LIB_KEY = 'docxLibraryCode_v8.5.0';
        const DOCX_CDN_URL = 'https://unpkg.com/docx@8.5.0/build/index.js';

        function injectScript(scriptText, callback) {
            const scriptElement = document.createElement('script');
            scriptElement.textContent = scriptText;
            document.head.appendChild(scriptElement);
            setTimeout(callback, 100); 
        }

        async function ensureApexChartsIsLoaded(callback) {
            if (typeof ApexCharts !== 'undefined') {
                callback();
                return;
            }

            const cachedScript = localStorage.getItem(APEX_LIB_KEY);
            if (cachedScript) {
                injectScript(cachedScript, callback);
            } else {
                try {
                    const response = await fetch(APEX_CDN_URL);
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
                    const scriptText = await response.text();
                    
                    try {
                        localStorage.setItem(APEX_LIB_KEY, scriptText);
                    } catch (e) {
                        console.warn(`Could not cache ApexCharts library: ${e.message}`);
                    }
                    
                    injectScript(scriptText, callback);
                } catch (error) {
                    console.error("Failed to fetch ApexCharts:", error);
                    alert("Tải thư viện biểu đồ thất bại. Vui lòng kiểm tra kết nối Internet và thử lại.");
                }
            }
        }
        
        async function ensureDocxIsLoaded(callback) {
            if (typeof docx !== 'undefined') {
                callback();
                return;
            }

            const cachedScript = localStorage.getItem(DOCX_LIB_KEY);
            if (cachedScript) {
                injectScript(cachedScript, callback);
            } else {
                try {
                    const response = await fetch(DOCX_CDN_URL);
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.status}`);
                    const scriptText = await response.text();
                    
                    try {
                        localStorage.setItem(DOCX_LIB_KEY, scriptText);
                    } catch (e) {
                        console.warn(`Could not cache Docx library: ${e.message}`);
                    }
                    
                    injectScript(scriptText, callback);
                } catch (error) {
                    console.error("Failed to fetch Docx:", error);
                    alert("Tải thư viện Docx thất bại. Vui lòng kiểm tra kết nối Internet và thử lại.");
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            initIndexedDB();
            showScreen('home-screen');
            initComparisonMenuListeners(); 
            initHelpModalListeners();
        });

        function initHelpModalListeners() {
            document.getElementById('comparison-help-btn').addEventListener('click', () => {
                document.getElementById('helpModal').style.display = 'block';
            });
        }
        
        function initEventListeners() {
            document.getElementById('create-quiz-btn').addEventListener('click', runReviewProcess);
            document.getElementById('docx-upload').addEventListener('change', handleDocxUpload);
            document.getElementById('start-btn').addEventListener('click', startQuiz);
            document.getElementById('shuffle-btn').addEventListener('click', toggleShuffle);
            document.getElementById('save-btn').addEventListener('click', saveQuiz);
            document.getElementById('submit-early-btn').addEventListener('click', submitEarly);
            document.getElementById('exportQuizBtn').addEventListener('click', exportSelectedQuizzes);
            document.getElementById('startQuizBtn').addEventListener('click', startSelectedQuiz);
            document.getElementById('deleteQuizBtn').addEventListener('click', deleteQuizFromModal);
            document.getElementById('deleteHistoryBtn').addEventListener('click', deleteHistoryFromModal);
            document.getElementById('import-quiz-btn').addEventListener('click', importQuiz);
            document.getElementById('check-quota-btn').addEventListener('click', checkStorageQuota);
            document.getElementById('startFromModalBtn').addEventListener('click', startFromModal);
            document.getElementById('clear-all-data-btn').addEventListener('click', clearAllData);
            
            let startX = 0;
            document.addEventListener("touchstart", (e) => {
                startX = e.touches[0].clientX;
            });
            document.addEventListener("touchend", (e) => {
                const endX = e.changedTouches[0].clientX;
                const diff = endX - startX;
                const activeScreen = document.querySelector('.screen.active');
                if (!activeScreen) return;
                
                if (activeScreen.id === 'saved-list-screen') {
                    if (diff < -50 && sidebarVisible) toggleSidebar(false);
                    if (diff > 50 && !sidebarVisible) toggleSidebar(true);
                } else if (activeScreen.id === 'history-list-screen') {
                    if (diff < -50 && historySidebarVisible) toggleHistorySidebar(false);
                    if (diff > 50 && !historySidebarVisible) toggleHistorySidebar(true);
                }
            });
            window.onpopstate = handlePopState;
        }

        // --- [ĐÃ CẬP NHẬT] ---
        function showScreen(screenId) {
            if (appState.currentScreen === screenId) return;

            // [SỬA LỖI 1] Logic dọn dẹp khi rời màn hình Lịch sử
            if (appState.currentScreen === 'history-list-screen') {
                closeHistoryModal();
                closeComparisonModal();
                const statsModal = document.getElementById('statisticsModal');
                if (statsModal) statsModal.style.display = 'none';
            }

            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            appState.lastScreen = appState.currentScreen;
            appState.currentScreen = screenId;

            if (screenId === 'home-screen') {
                // Đặt lại trạng thái ứng dụng
                appState.currentQuiz = [];
                appState.currentWarnings = [];
                appState.isQuizStarted = false;
                appState.userAnswers = [];
                appState.score = 0;
                appState.currentQuestionIndex = 0;
                appState.selectedQuizzes.clear();
                
                // [SỬA LỖI 2] Xóa nội dung ô nhập liệu
                const manualInput = document.getElementById('manual-input');
                if (manualInput) manualInput.value = '';

            } else if (screenId === 'saved-list-screen') {
                renderSavedQuizzesList();
                toggleSidebar(true);
                updateStartButton();
            } else if (screenId === 'history-list-screen') {
                renderHistoryList();
                toggleHistorySidebar(true);
            }
            
            if (screenId !== 'saved-list-screen') {
                document.getElementById('startQuizBtn').style.display = 'none';
            } else {
                updateStartButton();
            }

            if (!appState.isPopping && history.state?.screen !== screenId) {
                history.pushState({ screen: screenId }, '');
            }
        }
        function handlePopState(event) {
            appState.isPopping = true;
            if (appState.isQuizStarted) {
                if (confirm('Bạn có muốn quay lại không? Nếu có sẽ coi như nộp bài sớm.')) {
                    showResults();
                    showScreen('home-screen');
                    history.replaceState({ screen: 'home-screen' }, '');
                } else {
                    history.pushState({ screen: 'quiz-section' }, '');
                }
            } else {
                const targetScreen = event.state && event.state.screen ? event.state.screen : 'home-screen';
                showScreen(targetScreen);
            }
            appState.isPopping = false;
        }
        
        function handleDocxUpload(event) {
             const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    mammoth.extractRawText({arrayBuffer: e.target.result})
                        .then(function(result) {
                            document.getElementById('manual-input').value = result.value;
                            alert('Đã tải nội dung từ file DOCX!');
                        })
                        .catch(function(err) {
                            console.error(err);
                            alert('Lỗi khi đọc file DOCX!');
                        });
                };
                reader.readAsArrayBuffer(file);
            }
        }
        
        // --- [ĐÃ CẬP NHẬT] Thêm màn hình chờ ---
        function runReviewProcess() {
            const text = document.getElementById('manual-input').value;
            if (!text.trim()) {
                alert("Vui lòng nhập nội dung để soát lỗi!");
                return;
            }

            document.getElementById('loading-screen').style.display = 'flex';

            setTimeout(() => {
                appState.currentQuiz = nguoi_phan_loai(text);
                
                const warnings = appState.currentQuiz.filter(q => 
                    (q.type === 'multiple_choice' || q.type === 'multiple_answer') &&
                    !q.hasLineMarker &&
                    q.lua_chon.length > 4
                );
                appState.currentWarnings = warnings;
                renderReviewWarnings(warnings);

                if (appState.currentQuiz.length === 0 && warnings.length === 0) {
                    alert("Không nhận diện được câu hỏi hợp lệ nào. Vui lòng kiểm tra lại định dạng.");
                    document.getElementById('loading-screen').style.display = 'none';
                    return;
                }
                
                renderVisualReview(text);

                document.getElementById('loading-screen').style.display = 'none';
                showScreen('review-screen');
            }, 50); 
        }

        function nguoi_phan_loai(vanBan) {
            const ketQua = [];
            const regexTimThungHang = /#\*(trả|trắc|đúng)\*#\s*([\s\S]*?)\s*#\*\1\*#/gim;
            let ketQuaKhop;
            while ((ketQuaKhop = regexTimThungHang.exec(vanBan)) !== null) {
                const blockContentRaw = ketQuaKhop[2].trim();
                const blockType = ketQuaKhop[1].toLowerCase();
                const questionChunks = blockContentRaw.split(/(?=(?:câu|cau)\s*\d+[:.])/i).filter(c => c.trim());
                const chunksToParse = questionChunks.length > 0 ? questionChunks : [blockContentRaw];

                chunksToParse.forEach(chunk => {
                    let questionData = null;
                    if (blockType === 'trắc' || blockType === 'đúng') {
                        questionData = parseMultipleChoiceChunk(chunk, blockType);
                    } else if (blockType === 'trả') {
                        questionData = parseShortAnswerChunk(chunk);
                    }
                    if (questionData) ketQua.push(questionData);
                });
            }
            return ketQua.filter(q => q && q.cau_hoi);
        }

        function parseMultipleChoiceChunk(chunk, blockType) {
            const hasLineMarker = chunk.includes('#*dòng*#');
            if (hasLineMarker) {
                const markerIndex = chunk.indexOf('#*dòng*#');
                const questionText = chunk.substring(0, markerIndex).trim();
                const optionsBlock = chunk.substring(markerIndex + '#*dòng*#'.length).trim();
                const lua_chon = [];
                const dap_an_dung = [];
                
                optionsBlock.split('\n').forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine) {
                        lua_chon.push(trimmedLine);
                        if (trimmedLine.startsWith('*')) {
                            dap_an_dung.push(trimmedLine);
                        }
                    }
                });
                if (!questionText || lua_chon.length === 0) return null;
                const type = dap_an_dung.length > 1 ? 'multiple_answer' : 'multiple_choice';
                return { cau_hoi: questionText, lua_chon, dap_an_dung, type, hasLineMarker, blockType };
            }

            let questionText = '';
            let optionsBlock = '';
            let lua_chon = [];
            let dap_an_dung = [];
            
            const normalized = chunk.replace(/\r\n/g, "\n");
            const lines = normalized.split('\n');
            let optionStartIndex = -1;

            for (let i = 0; i < lines.length; i++) {
                if (optionPrefixRegex.test(lines[i].trim())) {
                    optionStartIndex = i;
                    break;
                }
            }
            
            if (optionStartIndex === -1) return null;

            questionText = lines.slice(0, optionStartIndex).join("\n").trim();
            optionsBlock = lines.slice(optionStartIndex).join("\n");
            
            const markers = Array.from(optionsBlock.matchAll(optionMarkerRegex));
            if (markers.length === 0) return null;

            for (let i = 0; i < markers.length; i++) {
                const currentMarker = markers[i];
                const nextMarker = markers[i + 1];
                const start = currentMarker.index;
                const end = nextMarker ? nextMarker.index : optionsBlock.length;
                const fullOptionText = optionsBlock.substring(start, end).trim();
                if (!fullOptionText) continue;

                const isCorrect = fullOptionText.startsWith('*');
                lua_chon.push(fullOptionText); 
                if (isCorrect) {
                    dap_an_dung.push(fullOptionText);
                }
            }

            if (!questionText || lua_chon.length === 0) return null;

            const uniqueCorrectAnswers = [...new Set(dap_an_dung)];
            const type = uniqueCorrectAnswers.length > 1 ? 'multiple_answer' : 'multiple_choice';

            return { cau_hoi: questionText, lua_chon, dap_an_dung: uniqueCorrectAnswers, type, hasLineMarker: false, blockType };
        }


        function parseShortAnswerChunk(chunk) {
            const answerRegex = /([\s\S]+?)(?:\*|đáp án:)\s*([\s\S]+)/i;
            const answerMatch = chunk.trim().match(answerRegex);
            if (answerMatch) {
                return {
                    cau_hoi: answerMatch[1].trim(),
                    lua_chon: [],
                    dap_an_dung: [answerMatch[2].trim()],
                    type: 'short_answer'
                };
            }
            return null;
        }

        function renderReviewWarnings(warnings) {
            const container = document.getElementById('review-warnings-container');
            if (!warnings || warnings.length === 0) {
                container.innerHTML = '';
                container.style.display = 'none';
                return;
            }

            let warningsHTML = `
            <div id="warning-collapsed" class="warning-collapsed" onclick="toggleWarningDetails()">
                ⚠️ Phát hiện ${warnings.length} câu hỏi có hơn 4 đáp án. Bấm để xem chi tiết.
            </div>
            <div id="warning-details" class="warning-details" style="display:none;">
                <h3 style="color: var(--danger-color); margin-top:0;">CHI TIẾT CÁC CÂU HỎI LỖI</h3>
                <p>Các câu hỏi sau có nhiều hơn 4 lựa chọn. Vui lòng kiểm tra lại hoặc sử dụng chức năng bên dưới.</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 15px 0;">
                    <button class="btn btn-danger" onclick="document.getElementById('manual-input').focus()">Hãy sửa</button>
                    <button class="btn btn-info" onclick="copyErrorQuestions()">Sao chép câu lỗi</button>
                    <button class="btn btn-success" onclick="exportErrorQuestionsToDocx()">Xuất câu lỗi</button>
                    <button class="btn btn-secondary" onclick="dismissWarnings()">Xóa lỗi</button>
                </div>
                <hr style="margin: 15px 0;">`;

            warnings.forEach(q => {
                warningsHTML += `
                <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #ccc;">
                    <h4>Nội dung câu hỏi vi phạm:</h4>
                    <p><strong>Câu hỏi:</strong> ${escapeHtml(q.cau_hoi)}</p>
                    <p><strong>Các đáp án (${q.lua_chon.length}):</strong></p>
                    <ul style="list-style-type: disc; margin-left: 20px;">
                        ${q.lua_chon.map(opt => `<li>${escapeHtml(opt)}</li>`).join('')}
                    </ul>
                </div>`;
            });
            
            warningsHTML += `
                <hr style="margin: 15px 0;">
                <h4>📝 Chú thích cách xử lý:</h4>
                <ul style="list-style-type: none; padding: 0;">
                    <li style="margin-bottom: 10px;"><strong>Cách 1 (Sửa thủ công):</strong> Chỉnh sửa câu hỏi trong ô nhập liệu để chỉ còn 4 lựa chọn.</li>
                    <li style="margin-bottom: 10px;"><strong>Cách 2 (Sao chép / Xuất file):</strong> Dùng nút <strong>"Sao chép"</strong> hoặc <strong>"Xuất câu lỗi"</strong>. File/văn bản tải về sẽ có sẵn định dạng <code>#*dòng*#</code>. Bạn chỉ cần sửa nội dung rồi dán lại.</li>
                    <li><strong>Cách 3 (Xóa lỗi):</strong> Dùng nút <strong>"Xóa lỗi"</strong> để loại bỏ những câu này khỏi bài thi.</li>
                </ul>
            </div>`;

            container.innerHTML = warningsHTML;
            container.style.display = 'block';
        }

        function toggleWarningDetails() {
            const collapsed = document.getElementById('warning-collapsed');
            const details = document.getElementById('warning-details');
            if (details.style.display === 'none') {
                details.style.display = 'block';
                collapsed.style.display = 'none';
            } else {
                details.style.display = 'none';
                collapsed.style.display = 'block';
            }
        }
        
        function copyErrorQuestions() {
            if (appState.currentWarnings.length === 0) {
                alert("Không có câu lỗi nào để sao chép.");
                return;
            }

            let textToCopy = '';
            appState.currentWarnings.forEach(q => {
                const wrapperTag = `#*${q.blockType}*#`;
                textToCopy += wrapperTag + '\n';
                textToCopy += q.cau_hoi + '\n';
                textToCopy += '#*dòng*#\n';
                textToCopy += q.lua_chon.join('\n') + '\n';
                textToCopy += wrapperTag + '\n\n';
            });

            navigator.clipboard.writeText(textToCopy.trim()).then(() => {
                alert(`Đã sao chép ${appState.currentWarnings.length} câu lỗi vào clipboard!`);
            }).catch(err => {
                console.error('Không thể sao chép văn bản: ', err);
                alert('Lỗi! Không thể sao chép. Vui lòng kiểm tra quyền truy cập clipboard của trình duyệt.');
            });
        }

        function dismissWarnings() {
            if (!confirm(`Bạn có chắc muốn xóa ${appState.currentWarnings.length} câu hỏi bị lỗi ra khỏi bài thi này không?`)) {
                return;
            }
            const warningQuestions = new Set(appState.currentWarnings.map(q => q.cau_hoi));
            appState.currentQuiz = appState.currentQuiz.filter(q => !warningQuestions.has(q.cau_hoi));
            
            appState.currentWarnings = [];
            document.getElementById('review-warnings-container').innerHTML = '';

            const originalText = document.getElementById('manual-input').value;
            renderVisualReview(originalText); 

            alert('Đã xóa các câu hỏi bị lỗi. Bạn có thể tiếp tục.');
        }

        function exportErrorQuestionsToDocx() {
            ensureDocxIsLoaded(() => {
                const { Document, Packer, Paragraph } = docx;
                if (appState.currentWarnings.length === 0) {
                    alert("Không có câu lỗi nào để xuất.");
                    return;
                }

                const children = [];
                appState.currentWarnings.forEach(q => {
                    const wrapperTag = `#*${q.blockType}*#`;
                    children.push(new Paragraph(wrapperTag));
                    
                    q.cau_hoi.split('\n').forEach(line => {
                        children.push(new Paragraph(line));
                    });

                    children.push(new Paragraph("#*dòng*#"));

                    q.lua_chon.forEach(option => {
                        children.push(new Paragraph(option));
                    });

                    children.push(new Paragraph(wrapperTag));
                    children.push(new Paragraph(" ")); 
                });

                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: children,
                    }],
                });

                Packer.toBlob(doc).then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    document.body.appendChild(a);
                    a.style = "display: none";
                    a.href = url;
                    a.download = "cau_hoi_loi_can_sua.docx";
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    alert('Đã xuất file "cau_hoi_loi_can_sua.docx"! Hãy mở file, sửa và dán lại nội dung.');
                });
            });
        }
        
        function renderVisualReview(text) {
            const outputDiv = document.getElementById('visual-review-output');
            outputDiv.innerHTML = ''; 
            const mainRegex = /#\*(trả|trắc|đúng)\*#\s*([\s\S]*?)\s*#\*\1\*#/gim;
            let resultHtml = '';
            let lastIndex = 0;
            let match;
            
            const validQuestionTexts = new Set(appState.currentQuiz.map(q => q.cau_hoi));

            while ((match = mainRegex.exec(text)) !== null) {
                if (match.index > lastIndex) {
                    resultHtml += `<span class="ignored">${escapeHtml(text.substring(lastIndex, match.index))}</span>`;
                }
                const blockContentRaw = match[2].trim();
                const blockType = match[1].toLowerCase();
                
                const questionChunks = blockContentRaw.split(/(?=(?:câu|cau)\s*\d+[:.])/i).filter(c => c.trim());
                const chunksToParse = questionChunks.length > 0 ? questionChunks : [blockContentRaw];

                resultHtml += `<div class="question-chunk">`;

                chunksToParse.forEach((chunk, index) => {
                    const parsedQuestion = (blockType === 'trắc' || blockType === 'đúng') ? parseMultipleChoiceChunk(chunk, blockType) : parseShortAnswerChunk(chunk);
                    
                    if (parsedQuestion && validQuestionTexts.has(parsedQuestion.cau_hoi)) {
                         if (blockType === 'trắc' || blockType === 'đúng') {
                            resultHtml += visualizeMultipleChoiceChunk(chunk);
                        } else if (blockType === 'trả') {
                            resultHtml += visualizeShortAnswerChunk(chunk);
                        }
                    } else {
                        resultHtml += `<span class="ignored">${escapeHtml(chunk)}</span>`;
                    }

                    if (chunksToParse.length > 1 && index < chunksToParse.length - 1) {
                        resultHtml += '<hr style="border: none; border-top: 1px dashed #ccc; margin: 10px 0;">';
                    }
                });

                resultHtml += `</div>`;
                lastIndex = mainRegex.lastIndex;
            }

            if (lastIndex < text.length) {
                resultHtml += `<span class="ignored">${escapeHtml(text.substring(lastIndex))}</span>`;
            }

            outputDiv.innerHTML = resultHtml;
        }

        function visualizeMultipleChoiceChunk(chunk) {
            const parsed = parseMultipleChoiceChunk(chunk, 'trắc');
            if (!parsed) return `<span class="ignored">${escapeHtml(chunk)}</span>`;

            let highlightedContent = `<span class="question">${escapeHtml(parsed.cau_hoi)}</span>`;
            
            const optionsBlock = parsed.lua_chon.join('\n');
            const markers = Array.from(optionsBlock.matchAll(optionMarkerRegex));
            
            if (markers.length > 0) {
                let lastOptionIndex = 0;
                markers.forEach((marker, i) => {
                    const nextMarker = markers[i + 1];
                    const start = marker.index;
                    const end = nextMarker ? nextMarker.index : optionsBlock.length;
                    
                    const whitespace = optionsBlock.substring(lastOptionIndex, start);
                    highlightedContent += escapeHtml(whitespace);

                    const optionText = optionsBlock.substring(start, end).trim();
                    const isCorrect = parsed.dap_an_dung.includes(optionText);
                    const className = isCorrect ? 'correct-answer' : 'incorrect-answer';
                    highlightedContent += `(<span class="${className}">${escapeHtml(optionText)}</span>)`;
                    lastOptionIndex = end;
                });
            }

            return highlightedContent;
        }

        function visualizeShortAnswerChunk(chunk) {
            const answerRegex = /([\s\S]+?)(?:\*|đáp án:)\s*([\s\S]+)/i;
            const answerMatch = chunk.trim().match(answerRegex);
            let result = '';
            if (answerMatch) {
                const questionText = answerMatch[1];
                const delimiter = answerMatch[0].replace(answerMatch[1], '').replace(answerMatch[2], '');
                const answerText = answerMatch[2];
                result += `<span class="question">${escapeHtml(questionText)}</span>`;
                result += escapeHtml(delimiter);
                result += `(<span class="correct-answer">${escapeHtml(answerText)}</span>)`;
            } else {
                result = `<span class="ignored">${escapeHtml(chunk)}</span>`;
            }
            return result;
        }
        
        function prepareQuizUI(questions, doShowScreen = true) {
            appState.currentQuiz = questions;
            appState.originalQuizOrder = [...questions];
            appState.isShuffled = false;
            if (doShowScreen) {
                showScreen('quiz-section');
            }
            document.getElementById('quiz-live-container').innerHTML = '';
            document.getElementById('results-container').style.display = 'none';
            const startBtn = document.getElementById('start-btn');
            startBtn.style.display = 'inline-block';
            startBtn.textContent = 'Bắt Đầu';
            const shuffleBtn = document.getElementById('shuffle-btn');
            shuffleBtn.style.display = 'inline-block';
            shuffleBtn.textContent = 'Trộn câu hỏi và đáp án: Tắt';
            const saveBtn = document.getElementById('save-btn');
            saveBtn.style.display = 'inline-block';
            document.getElementById('submit-early-btn').style.display = 'none';
        }
        function startQuiz() {
            appState.score = 0;
            appState.currentQuestionIndex = 0;
            appState.userAnswers = [];
            appState.isQuizStarted = true;
            appState.shuffledQuizMap = [];
            appState.shuffledOptionsMap = [];
            if (appState.isShuffled) {
                let indices = Array.from({length: appState.currentQuiz.length}, (_, i) => i);
                indices.sort(() => Math.random() - 0.5);
                appState.shuffledQuizMap = indices;
                appState.currentQuiz = indices.map(i => ({...appState.originalQuizOrder[i]}));
            } else {
                appState.currentQuiz = [...appState.originalQuizOrder];
            }
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('shuffle-btn').style.display = 'none';
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('submit-early-btn').style.display = 'inline-block';
            displayQuestion();
        }

        function displayQuestion() {
            const container = document.getElementById('quiz-live-container');
            if (appState.currentQuestionIndex >= appState.currentQuiz.length) {
                showResults();
                return;
            }
            const q = appState.currentQuiz[appState.currentQuestionIndex];
            let optionsToDisplay = [...q.lua_chon];

            if (appState.isShuffled && (q.type === 'multiple_choice' || q.type === 'multiple_answer')) {
                 if (q.hasLineMarker) {
                    let optionObjects = q.lua_chon.map((opt, index) => ({ text: opt, originalIndex: index }));
                    optionObjects.sort(() => Math.random() - 0.5);
                    optionsToDisplay = optionObjects.map(obj => obj.text);
                    appState.shuffledOptionsMap[appState.currentQuestionIndex] = optionObjects.map(obj => obj.originalIndex);
                 } else {
                    const originalLabels = q.lua_chon.map(opt => (opt.match(optionPrefixRegex) || [''])[0]);
                    const originalContents = q.lua_chon.map(opt => opt.replace(optionPrefixRegex, '').replace(/^\*/, '').trim());
                    let contentIndices = Array.from({ length: originalContents.length }, (_, i) => i);
                    contentIndices.sort(() => Math.random() - 0.5);
                    appState.shuffledOptionsMap[appState.currentQuestionIndex] = contentIndices;
                    optionsToDisplay = originalLabels.map((label, index) => {
                        const shuffledContentIndex = contentIndices[index];
                        const originalOptionWithStar = q.lua_chon.find(opt => opt.replace(optionPrefixRegex, '').replace(/^\*/, '').trim() === originalContents[shuffledContentIndex]);
                        return originalOptionWithStar || (label + originalContents[shuffledContentIndex]);
                    });
                 }
            }

            let questionHTML = `<div class="question-container" id="q-${appState.currentQuestionIndex}">
                <p class="question-text">Câu ${appState.currentQuestionIndex + 1}: ${q.cau_hoi ? q.cau_hoi.replace(/\n/g, '<br>') : 'Nội dung không xác định'}</p>
                <div class="options-container">`;
            
            const createOptionHTML = (type, value) => {
                const cleanText = value.replace(/^\*/, '').trim();
                return `<label><input type="${type}" name="option-${appState.currentQuestionIndex}" value="${escapeHtml(value)}" class="mr-2"> ${escapeHtml(cleanText)}</label>`;
            };
            
            if (q.type === 'multiple_choice') {
                optionsToDisplay.forEach(c => questionHTML += createOptionHTML('radio', c));
            } else if (q.type === 'multiple_answer') {
                 optionsToDisplay.forEach(c => questionHTML += createOptionHTML('checkbox', c));
            } else {
                questionHTML += `<input type="text" id="short-answer-input-${appState.currentQuestionIndex}" placeholder="Nhập câu trả lời..." style="width:100%; padding:10px; font-size:16px;">`;
            }
            
            questionHTML += `</div><div class="feedback"></div>
                             <button class="btn" style="margin-top:15px;" onclick="checkAnswer()">Trả Lời</button>
                             </div>`;
            container.innerHTML = questionHTML;
        }

        function checkAnswer() {
            const q = appState.currentQuiz[appState.currentQuestionIndex];
            const container = document.getElementById(`q-${appState.currentQuestionIndex}`);
            const inputs = container.querySelectorAll('input');
            const feedbackDiv = container.querySelector('.feedback');

            const getCleanContent = (text) => {
                if (!text) return '';
                return text.replace(optionPrefixRegex, '').replace(/^\*/, '').trim();
            };

            let isCorrect = false;
            let selected = [];
            inputs.forEach(input => input.disabled = true);
            
            const cleanCorrectAnswers = q.dap_an_dung.map(ans => getCleanContent(ans));

            if (q.type === 'multiple_choice') {
                const sel = container.querySelector(`input[type="radio"]:checked`);
                if (sel) {
                    selected = [sel.value];
                    const cleanSelectedContent = getCleanContent(selected[0]);
                    isCorrect = cleanCorrectAnswers.includes(cleanSelectedContent);
                }
            } else if (q.type === 'multiple_answer') {
                selected = Array.from(container.querySelectorAll(`input[type="checkbox"]:checked`)).map(el => el.value);
                const cleanSelectedContents = selected.map(s => getCleanContent(s));
                isCorrect = cleanSelectedContents.length === cleanCorrectAnswers.length && cleanSelectedContents.every(s => cleanCorrectAnswers.includes(s));
            } else { 
                const userAnswer = container.querySelector(`#short-answer-input-${appState.currentQuestionIndex}`).value.trim();
                selected = [userAnswer];
                isCorrect = q.dap_an_dung.some(ans => ans.toLowerCase() === userAnswer.toLowerCase());
            }

            appState.userAnswers.push({ questionIndex: appState.currentQuestionIndex, selected, isCorrect });

            if (isCorrect) appState.score++;
            feedbackDiv.textContent = `${isCorrect ? 'Đúng' : 'Sai'}`;
            if (!isCorrect) {
                feedbackDiv.textContent += ` - Đáp án đúng: ${q.dap_an_dung.join(', ')}`;
            }

            container.querySelectorAll('label').forEach(label => {
                const input = label.querySelector('input');
                if (input) {
                    const isAnswerKey = q.dap_an_dung.some(correct_ans => getCleanContent(correct_ans) === getCleanContent(input.value));
                    if (isAnswerKey) {
                        label.style.backgroundColor = '#d4edda';
                    } else if (input.checked) {
                        label.style.backgroundColor = '#f8d7da';
                    }
                }
            });

            const button = container.querySelector('button');
            button.textContent = 'Câu Tiếp Theo';
            button.onclick = nextQuestion;
        }

        function nextQuestion() {
            appState.currentQuestionIndex++;
            displayQuestion();
        }
        function submitEarly() {
            if (confirm('Bạn có chắc muốn nộp bài sớm không? Các câu chưa làm sẽ coi như sai.')) {
                showResults();
            }
        }
        function showResults() {
            appState.isQuizStarted = false;
            document.getElementById('quiz-live-container').innerHTML = '';
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.style.display = 'block';
            const total = appState.currentQuiz.length;
            document.getElementById('final-score').textContent = `Bạn đã đúng ${appState.score} / ${total} câu!`;
            saveHistory(appState.userAnswers, appState.score, total);
            document.getElementById('start-btn').textContent = 'Làm Lại';
            document.getElementById('start-btn').style.display = 'inline-block';
            document.getElementById('shuffle-btn').style.display = 'inline-block';
            document.getElementById('save-btn').style.display = 'inline-block';
            document.getElementById('submit-early-btn').style.display = 'none';
        }
        function toggleShuffle() {
            appState.isShuffled = !appState.isShuffled;
            document.getElementById('shuffle-btn').textContent = `Trộn câu hỏi và đáp án: ${appState.isShuffled ? 'Bật' : 'Tắt'}`;
        }
        let db;
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                if (db) return resolve(true);
                const request = indexedDB.open('QuizAppDB', 2);
                request.onupgradeneeded = function(event) {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('quizStore')) {
                        db.createObjectStore('quizStore', { keyPath: 'id' });
                    }
                };
                request.onsuccess = function(event) {
                    db = event.target.result;
                    resolve(true);
                };
                request.onerror = function(event) {
                    console.error("Lỗi mở IndexedDB: ", event);
                    reject(false);
                };
            });
        }
        async function saveToStorage(key, value) {
            try {
                const compressed = LZString.compress(JSON.stringify(value));
                localStorage.setItem(key, compressed);
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    console.warn(`LocalStorage quota exceeded for key ${key}. Trying IndexedDB.`);
                    try {
                        const compressed = LZString.compress(JSON.stringify(value));
                        await initIndexedDB();
                        const transaction = db.transaction(['quizStore'], 'readwrite');
                        const store = transaction.objectStore('quizStore');
                        store.put({ id: key, data: compressed });
                    } catch (dbError) {
                        console.error(`Failed to save ${key} to IndexedDB:`, dbError);
                        alert('Không thể lưu dữ liệu. Bộ nhớ đã đầy.');
                    }
                } else {
                    console.error("Lỗi lưu vào localStorage:", e);
                    alert('Đã xảy ra lỗi khi lưu dữ liệu.');
                }
            }
        }

        async function getFromStorage(key) {
            try {
                const localData = localStorage.getItem(key);
                if (localData) {
                    const decompressed = LZString.decompress(localData);
                    if (decompressed) {
                        return JSON.parse(decompressed);
                    }
                    return null;
                }
            } catch (e) {
                console.error(`[Lỗi] Không thể phân tích dữ liệu localStorage cho key '${key}'. Dữ liệu có thể bị hỏng. Lỗi:`, e);
            }
            
            try {
                await initIndexedDB();
                return new Promise((resolve) => {
                    const transaction = db.transaction(['quizStore'], 'readonly');
                    const store = transaction.objectStore('quizStore');
                    const request = store.get(key);

                    request.onsuccess = () => {
                        if (!request.result || !request.result.data) {
                            return resolve(null);
                        }
                        try {
                            const decompressed = LZString.decompress(request.result.data);
                            const result = decompressed ? JSON.parse(decompressed) : null;
                            resolve(result);
                        } catch (e) {
                            console.error(`[Lỗi] Không thể phân tích dữ liệu IndexedDB cho key '${key}'. Dữ liệu có thể bị hỏng. Lỗi:`, e);
                            resolve(null);
                        }
                    };
                    request.onerror = () => {
                        console.error(`Lỗi khi lấy '${key}' từ IndexedDB.`);
                        resolve(null);
                    };
                });
            } catch (dbError) {
                console.error(`Không thể lấy '${key}' từ IndexedDB:`, dbError);
                return null;
            }
        }
        
        async function checkStorageQuota() {
            let localStorageUsed = 0;
            for (let x in localStorage) {
                if (localStorage.hasOwnProperty(x)) {
                    localStorageUsed += ((localStorage[x].length + x.length) * 2);
                }
            }
            const localStorageTotal = 5 * 1024 * 1024;
            const localStorageRemaining = (localStorageTotal - localStorageUsed) / (1024 * 1024);
            if (navigator.storage && navigator.storage.estimate) {
                navigator.storage.estimate().then(estimate => {
                    const indexedDBQuota = estimate.quota / (1024 * 1024);
                    const indexedDBUsed = estimate.usage / (1024 * 1024);
                    const indexedDBRemaining = indexedDBQuota - indexedDBUsed;
                    alert(`Dung lượng còn lại:\n- localStorage: ${localStorageRemaining.toFixed(2)} MB (tổng ~5MB)\n- IndexedDB: ${indexedDBRemaining.toFixed(2)} MB (tổng ~${indexedDBQuota.toFixed(2)} MB)`);
                }).catch(() => {
                    alert(`Dung lượng còn lại:\n- localStorage: ${localStorageRemaining.toFixed(2)} MB (tổng ~5MB)\n- IndexedDB: Không thể kiểm tra.`);
                });
            } else {
                alert(`Dung lượng còn lại:\n- localStorage: ${localStorageRemaining.toFixed(2)} MB (tổng ~5MB)\n- IndexedDB: Không được hỗ trợ.`);
            }
        }
        async function saveQuiz() {
            const name = prompt("Nhập tên để lưu bài thi này:", `Bài thi ngày ${new Date().toLocaleDateString('vi-VN')}`);
            if (name) {
                const savedQuizzes = await getFromStorage('savedQuizzes') || {};
                if (savedQuizzes[name]) {
                    if (!confirm("Tên bài thi đã tồn tại! Bạn có muốn ghi đè không?")) {
                       return;
                    }
                }
                savedQuizzes[name] = appState.originalQuizOrder;
                await saveToStorage('savedQuizzes', savedQuizzes);
                alert(`Đã lưu bài thi "${name}"!`);
            }
        }
        async function renderSavedQuizzesList() {
            const container = document.getElementById('saved-quizzes-list');
            container.innerHTML = '';
            const quizzes = await getFromStorage('savedQuizzes') || {};
            if (!quizzes || typeof quizzes !== 'object') {
                container.innerHTML = '<p class="text-red-500 p-2">Lỗi đọc dữ liệu các bài đã lưu.</p>';
                return;
            }
            const keys = Object.keys(quizzes);
            if (keys.length === 0) {
                container.innerHTML = '<p class="text-gray-500 p-2">Chưa có bài nào được lưu.</p>';
                return;
            }

            keys.forEach((key, index) => {
                const colorInfo = pillColorConfig.colors[index % pillColorConfig.colors.length];
                const btn = document.createElement('button');
                btn.dataset.id = key;
                btn.dataset.color = colorInfo.name;
                btn.textContent = key;

                if (appState.selectedQuizzes.has(key)) {
                    btn.className = `${pillColorConfig.baseClasses} ${pillColorConfig.selectedClasses}`;
                } else {
                    btn.className = `${pillColorConfig.baseClasses} ${colorInfo.classes}`;
                }

                btn.onclick = () => toggleQuizSelection(key);
                container.appendChild(btn);
            });
            updateExportButton();
            updateStartButton();
        }

        function toggleQuizSelection(qid) {
            const btn = document.querySelector(`#saved-quizzes-list [data-id="${qid}"]`);
            if (!btn) return;
            const originalColorName = btn.dataset.color;
            const colorInfo = pillColorConfig.colors.find(c => c.name === originalColorName);

            if (appState.selectedQuizzes.has(qid)) {
                appState.selectedQuizzes.delete(qid);
                btn.className = `${pillColorConfig.baseClasses} ${colorInfo.classes}`;
            } else {
                appState.selectedQuizzes.add(qid);
                btn.className = `${pillColorConfig.baseClasses} ${pillColorConfig.selectedClasses}`;
            }
            showQuizDetailsInBox();
            updateStartButton();
            updateExportButton();
        }

        async function showQuizDetailsInBox() {
            const questionBox = document.getElementById('questionBox');
            questionBox.innerHTML = '';
            if (appState.selectedQuizzes.size === 0) {
                 questionBox.classList.add("hidden");
                 return;
            }
            
            const quizzes = await getFromStorage('savedQuizzes');
            if (!quizzes) return; 
            
            appState.selectedQuizzes.forEach(qid => {
                 const quizData = quizzes[qid];
                 if (Array.isArray(quizData)) { 
                    const div = document.createElement("div");
                    div.id = `box-${qid}`;
                    div.className = "p-3 border rounded bg-gray-50";
                    div.innerHTML = `<p class="font-bold">${qid} (${quizData.length} câu)</p>
                                      <div class="mt-2">
                                         <button class="btn text-sm p-2" onclick="viewQuiz('${qid}')">Xem</button>
                                         <button class="btn text-sm p-2 btn-secondary" onclick="exportSingleQuiz('${qid}')">Xuất</button>
                                      </div>`;
                    questionBox.appendChild(div);
                 }
            });
            questionBox.classList.remove("hidden");
        }
        function updateExportButton() {
            const exportBtn = document.getElementById('exportQuizBtn');
            exportBtn.style.display = appState.selectedQuizzes.size > 0 ? 'inline-block' : 'none';
        }
        function updateStartButton() {
            const startBtn = document.getElementById('startQuizBtn');
            if (appState.currentScreen === 'saved-list-screen' && appState.selectedQuizzes.size > 0) {
                startBtn.style.display = 'block';
                startBtn.textContent = `Bắt đầu (${appState.selectedQuizzes.size} đề)`;
            } else {
                startBtn.style.display = 'none';
            }
        }
        async function startSelectedQuiz() {
            const savedQuizzes = await getFromStorage('savedQuizzes') || {};
            let combinedQuiz = [];
            if (appState.selectedQuizzes.size > 0) {
                appState.selectedQuizzes.forEach(quizName => {
                    if (savedQuizzes[quizName] && Array.isArray(savedQuizzes[quizName])) {
                        combinedQuiz = combinedQuiz.concat(savedQuizzes[quizName]);
                    }
                });
                if (combinedQuiz.length > 0) {
                    prepareQuizUI(combinedQuiz, true);
                }
            }
        }
        function startFromModal() {
            if (appState.currentModalQuiz) {
                prepareQuizUI(appState.currentModalQuiz, true);
                closeModal();
            }
        }
        async function viewQuiz(qid) {
            const savedQuizzes = await getFromStorage('savedQuizzes') || {};
            if (!savedQuizzes || !savedQuizzes[qid]) {
                alert(`Không tìm thấy hoặc lỗi đọc bài thi "${qid}"!`);
                return;
            }
            appState.currentModalQuiz = savedQuizzes[qid];
            const modal = document.getElementById('contentModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const startBtn = document.getElementById('startFromModalBtn');
            
            modalTitle.textContent = `Nội dung bài thi: ${qid}`;
            modalContent.innerHTML = '<h4>Danh sách câu hỏi:</h4>';
            appState.currentModalQuiz.forEach((q, index) => {
                let contentHTML = `<div style="margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eee;"><p><strong>Câu ${index + 1}:</strong> ${q.cau_hoi ? q.cau_hoi.replace(/\n/g, '<br>') : 'Nội dung không xác định'}</p>`;
                if (q.lua_chon && q.lua_chon.length > 0) {
                    contentHTML += '<ul>' + q.lua_chon.map(c => `<li ${q.dap_an_dung.includes(c) ? 'style="color:green;font-weight:bold;"' : ''}>${c}</li>`).join('') + '</ul>';
                } else {
                    contentHTML += `<p><em>Đáp án: ${q.dap_an_dung.join(', ')}</em> ✅</p>`;
                }
                modalContent.innerHTML += contentHTML + '</div>';
            });
            startBtn.textContent = "Bắt đầu làm bài";
            startBtn.style.display = 'inline-block';
            document.getElementById('deleteQuizBtn').onclick = () => deleteQuizFromModal(qid);
            modal.style.display = 'block';
        }
        function closeModal() {
            document.getElementById('contentModal').style.display = 'none';
        }
        async function deleteQuizFromModal(qid) {
            if (confirm(`Bạn có chắc muốn xóa bài thi "${qid}" không?`)) {
                const quizzes = await getFromStorage('savedQuizzes') || {};
                delete quizzes[qid];
                await saveToStorage('savedQuizzes', quizzes);
                appState.selectedQuizzes.delete(qid);
                closeModal();
                renderSavedQuizzesList();
                showQuizDetailsInBox();
                updateStartButton();
                alert(`Đã xóa bài thi "${qid}"!`);
            }
        }
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        let sidebarVisible = true;
        function toggleSidebar(show) {
            sidebarVisible = show;
            if (show) {
                sidebar.style.transform = "translateX(0)";
                mainContent.classList.remove("full");
                mainContent.classList.add("with-sidebar");
            } else {
                sidebar.style.transform = "translateX(-100%)";
                mainContent.classList.remove("with-sidebar");
                mainContent.classList.add("full");
            }
        }
        const historySidebar = document.getElementById('history-sidebar');
        const historyMainContent = document.getElementById('history-mainContent');
        let historySidebarVisible = true;
        function toggleHistorySidebar(show) {
            historySidebarVisible = show;
            if (show) {
                historySidebar.style.transform = "translateX(0)";
                historyMainContent.classList.remove("full");
                historyMainContent.classList.add("with-sidebar");
            } else {
                historySidebar.style.transform = "translateX(-100%)";
                historyMainContent.classList.remove("with-sidebar");
                historyMainContent.classList.add("full");
            }
        }
        async function saveHistory(answers, score, total) {
            let history = await getFromStorage('quizHistory') || [];
            if (!Array.isArray(history)) history = [];
            const entry = {
                id: Date.now(),
                quiz: appState.originalQuizOrder,
                shuffledQuizMap: appState.shuffledQuizMap,
                shuffledOptionsMap: appState.shuffledOptionsMap,
                answers,
                score,
                total,
                isShuffled: appState.isShuffled,
                date: new Date().toLocaleString('vi-VN')
            };
            history.unshift(entry);
            if (history.length > 20) history.pop();
            await saveToStorage('quizHistory', history);
        }
        async function renderHistoryList() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            const history = await getFromStorage('quizHistory') || [];
             if (!Array.isArray(history)) {
                container.innerHTML = '<p class="text-red-500 p-2">Lỗi đọc dữ liệu lịch sử.</p>';
                return;
            }
            if (history.length === 0) {
                container.innerHTML = '<p class="text-gray-500 p-2">Chưa có lịch sử làm bài.</p>';
                return;
            }
            history.forEach((entry, index) => {
                if (!entry || typeof entry.date === 'undefined' || typeof entry.score === 'undefined') {
                    console.error('Bỏ qua mục lịch sử bị lỗi:', entry);
                    return;
                }
                const colorInfo = pillColorConfig.colors[index % pillColorConfig.colors.length];
                const btn = document.createElement('button');
                btn.dataset.id = entry.id;
                btn.dataset.color = colorInfo.name;
                btn.textContent = `${entry.date} (${entry.score}/${entry.total})`;
                btn.className = `${pillColorConfig.baseClasses} ${colorInfo.classes}`;
                
                btn.onclick = () => {
                    const wasSelected = btn.classList.contains('bg-gray-500');

                    container.querySelectorAll('button').forEach(b => {
                        const originalColorName = b.dataset.color;
                        const originalColorInfo = pillColorConfig.colors.find(c => c.name === originalColorName);
                        if(originalColorInfo) {
                           b.className = `${pillColorConfig.baseClasses} ${originalColorInfo.classes}`;
                        }
                    });

                    const questionBox = document.getElementById('history-questionBox');
                    questionBox.innerHTML = '';
                    questionBox.classList.add("hidden");

                    if (!wasSelected) {
                        btn.className = `${pillColorConfig.baseClasses} ${pillColorConfig.selectedClasses}`;

                        const div = document.createElement("div");
                        div.className = "p-3 border rounded bg-gray-50";
                        let content = `<p class="font-bold">Kết quả ngày ${entry.date} (Điểm: ${entry.score}/${entry.total})</p>
                                       <button class="btn text-sm p-2 mt-2" onclick="showHistoryContent('${entry.id}')">Xem Chi Tiết</button>`;
                        if (entry.isShuffled) {
                            content += `<button class="btn text-sm p-2 mt-2 ml-2" onclick="showComparison(${entry.id})">Xem so sánh</button>`;
                        }
                        content += `<button class="btn btn-warning text-sm p-2 mt-2 ml-2" onclick="showStatistics(${entry.id})">Thống kê</button>`;
                        div.innerHTML = content;
                        questionBox.appendChild(div);
                        questionBox.classList.remove("hidden");
                    }
                };
                container.appendChild(btn);
            });
        }
        
        async function showHistoryContent(hid) {
            const history = await getFromStorage('quizHistory') || [];
            const entry = history.find(e => e.id == hid);
            if (!entry) return;
            appState.currentModalHistory = entry;
            const modal = document.getElementById('history-contentModal');
            const modalTitle = document.getElementById('history-modalTitle');
            const modalContent = document.getElementById('history-modalContent');
            
            modalTitle.textContent = `Lịch sử làm bài: ${entry.date}`;
            modalContent.innerHTML = `<h4>Điểm: ${entry.score}/${entry.total}</h4>`;
            
            const quizData = entry.isShuffled ? entry.shuffledQuizMap.map(i => entry.quiz[i]) : entry.quiz;
            
            quizData.forEach((q, index) => {
                const userAnswerEntry = entry.answers.find(a => a.questionIndex === index) || { selected: [], isCorrect: false };
                let contentHTML = `<div style="margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eee;"><p><strong>Câu ${index + 1}:</strong> ${q.cau_hoi ? q.cau_hoi.replace(/\n/g, '<br>') : 'Nội dung không xác định'}</p>`;
                
                const originalQuestionIndex = entry.isShuffled ? entry.shuffledQuizMap[index] : index;
                const correctAnswers = entry.quiz[originalQuestionIndex].dap_an_dung;

                if (q.lua_chon && q.lua_chon.length > 0) {
                     const getCleanContent = (text) => {
                        if (!text) return '';
                        if(q.hasLineMarker) return text.replace(/^\*/, '').trim();
                        return text.replace(optionPrefixRegex, '').replace(/\*/g, '').trim();
                    };

                    contentHTML += '<ul>' + q.lua_chon.map(c => {
                        const isAnswerKey = correctAnswers.some(ans => getCleanContent(ans) === getCleanContent(c));
                        const isSelected = userAnswerEntry.selected.some(sel => getCleanContent(sel) === getCleanContent(c));
                        
                        let style = '';
                        if (isSelected) {
                            style = isAnswerKey 
                                ? 'color: var(--success-color); font-weight: bold;'
                                : 'color: var(--danger-color);';
                        } else if (isAnswerKey) {
                            style = 'color: var(--success-color); text-decoration: underline;';
                        }
                        
                        return `<li style="${style}">${c}</li>`;
                    }).join('') + '</ul>';
                }

                contentHTML += `<p>Câu trả lời của bạn: <strong>${userAnswerEntry.selected.join(', ') || 'Chưa trả lời'}</strong> - <strong style="color:${userAnswerEntry.isCorrect ? 'var(--success-color)' : 'var(--danger-color)'};">${userAnswerEntry.isCorrect ? 'Đúng' : 'Sai'}</strong></p>`;
                if (!userAnswerEntry.isCorrect) {
                     contentHTML += `<p style="color: var(--success-color);"><em>Đáp án đúng: ${correctAnswers.join(', ')}</em></p>`;
                }
                modalContent.innerHTML += contentHTML + '</div>';
            });
            document.getElementById('deleteHistoryBtn').onclick = () => deleteHistory(hid);
            modal.style.display = 'block';
        }
        
        function showStatistics(hid) {
            ensureApexChartsIsLoaded(async () => {
                try {
                    const history = await getFromStorage('quizHistory') || [];
                    const entry = history.find(e => e.id == hid);
                    if (!entry) {
                        alert("Lỗi: Không tìm thấy lịch sử làm bài.");
                        return;
                    }
                
                    const modal = document.getElementById('statisticsModal');
                    const modalTitle = document.getElementById('statistics-modalTitle');
                    const legendContent = document.getElementById('statistics-legend');
                    
                    const correctCount = entry.score;
                    const answeredCount = entry.answers.length;
                    const incorrectCount = answeredCount - correctCount;
                    const unansweredCount = entry.total - answeredCount;
                    const correctPercentage = entry.total > 0 ? ((correctCount / entry.total) * 100).toFixed(1) : 0;
                    
                    const quizSignature = JSON.stringify(entry.quiz.map(q => q.cau_hoi).sort());
                    const quizAttempts = history.filter(h => JSON.stringify(h.quiz.map(q => q.cau_hoi).sort()) === quizSignature).length;
                
                    modalTitle.textContent = `Thống kê: ${entry.date}`;
                
                    legendContent.innerHTML = `
                        <p><strong>Kết quả:</strong> 
                            <span style="color:var(--success-color)">${correctCount} Đúng</span> / 
                            <span style="color:var(--danger-color)">${incorrectCount} Sai</span> / 
                            <span style="color:var(--secondary-color)">${unansweredCount} Chưa làm</span>
                            (trên tổng ${entry.total} câu).
                        </p>
                        <p><strong>Tỉ lệ đúng:</strong> ${correctPercentage}%</p>
                        <p><strong>Số lần làm bài này:</strong> ${quizAttempts}</p>
                    `;
                    
                    const chartEl = document.querySelector("#statistics-chart");
                    if(window.statisticsChart) {
                        window.statisticsChart.destroy();
                    }

                    const seriesData = [correctCount, incorrectCount, unansweredCount];
                    const labelsData = ['Đúng', 'Sai', 'Chưa làm'];
                    const colorsData = [
                        getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim(), 
                        getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim(),
                        getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim()
                    ];

                    const options = {
                        chart: { type: 'pie', height: 320, animations: { enabled: true } },
                        series: seriesData,
                        labels: labelsData,
                        colors: colorsData,
                        legend: { position: 'bottom' },
                        tooltip: { y: { formatter: (val) => val + " câu" } },
                        dataLabels: {
                            formatter: (val, opts) => {
                                 const total = opts.w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                if (opts.w.globals.series[opts.seriesIndex] === 0 || total === 0) return '';
                                const percent = ((opts.w.globals.series[opts.seriesIndex] / total) * 100).toFixed(0) + '%';
                                return percent;
                            },
                            style: { colors: ['#fff'] },
                            dropShadow: { enabled: true, top: 1, left: 1, blur: 1, opacity: 0.5 }
                        }
                    };
                    
                    if (correctCount === 0 && incorrectCount === 0 && unansweredCount === 0) {
                        options.series = [1];
                        options.labels = ['Chưa có dữ liệu'];
                        options.colors = ['#B0B0B0'];
                    }

                    window.statisticsChart = new ApexCharts(chartEl, options);
                    window.statisticsChart.render();
                    
                    modal.style.display = 'block';
                
                    document.getElementById('statistics-close-btn').onclick = () => {
                        modal.style.display = 'none';
                    };
                } catch (e) {
                    console.error("Error in showStatistics:", e);
                    alert("Đã xảy ra lỗi khi hiển thị thống kê: " + e.message);
                }
            });
        }
        
        let largeSearchMatches = [];
        let currentMatchIndex = -1;

        async function showComparison(hid) {
            const history = await getFromStorage('quizHistory') || [];
            const entry = history.find(e => e.id == hid);
            if (!entry || !entry.isShuffled) {
                alert("Lỗi: Không tìm thấy lịch sử hoặc đây không phải là bài thi đã được xáo trộn.");
                return;
            }

            const modal = document.getElementById('comparisonModal');
            const modalTitle = document.getElementById('comparison-modalTitle');
            const comparisonContainer = document.getElementById('comparison-content');
            
            const fragment = document.createDocumentFragment();
            const lightColors = ['#D4EDDA', '#FFF3CD', '#D1ECF1', '#F8D7DA', '#E2E3E5', '#CCE5FF'];

            entry.shuffledQuizMap.forEach((originalIndex, shuffledIndex) => {
                const originalQ = entry.quiz[originalIndex];
                const userAnswerEntry = entry.answers.find(a => a.questionIndex === shuffledIndex);

                const questionBlock = document.createElement('div');
                questionBlock.className = 'comparison-question';
                questionBlock.id = `comp-q-shuffled-${shuffledIndex + 1}`;
                questionBlock.dataset.originalIndex = originalIndex + 1;
                
                let questionBlockHTML = `<h4 style="text-align:center; color: #0056b3; font-weight: bold;">Câu gốc ${originalIndex + 1} &rArr; Câu xáo trộn ${shuffledIndex + 1}</h4>
                    <p class="comparison-question-text">${originalQ.cau_hoi.replace(/\n/g, '<br>')}</p>`;

                if (originalQ.type === 'short_answer') {
                    const correctAnswer = originalQ.dap_an_dung.join(', ');
                    let userAnswerHTML = '<em>(Chưa trả lời)</em>';
                    if (userAnswerEntry && userAnswerEntry.selected.length > 0 && userAnswerEntry.selected[0]) {
                        const userAnswer = userAnswerEntry.selected[0];
                        const userAnswerColor = userAnswerEntry.isCorrect ? 'var(--success-color)' : 'var(--danger-color)';
                        userAnswerHTML = `<strong style="color: ${userAnswerColor};">${userAnswer}</strong>`;
                    }
                    questionBlockHTML += `<div style="text-align:center; padding:10px; background-color:#f0f0f0; border-radius:8px;">
                                            <p>Đáp án đúng: <strong style="color: var(--success-color);">${correctAnswer}</strong></p>
                                            <p>Bạn đã trả lời: ${userAnswerHTML}</p>
                                         </div>`;
                } else {
                    questionBlockHTML += `<div class="options-comparison-wrapper">`;
                    
                    questionBlockHTML += `<div class="options-column"><h5>Đáp án gốc</h5>`;
                    originalQ.lua_chon.forEach((opt, idx) => {
                        const isCorrect = originalQ.dap_an_dung.includes(opt);
                        const style = isCorrect ? 'color: var(--success-color); font-weight: bold;' : 'color: var(--text-color);';
                        const color = lightColors[idx % lightColors.length];
                        questionBlockHTML += `<div class="option-item" style="background-color: ${color};"><span style="${style}">${opt}</span></div>`;
                    });
                    questionBlockHTML += `</div>`;
                    
                    questionBlockHTML += `<div class="options-column"><h5>Đáp án đã xáo trộn (Bạn làm)</h5>`;
                    const shuffledContentIndices = entry.shuffledOptionsMap[shuffledIndex] || [];
                    const userSelectedOptions = userAnswerEntry ? userAnswerEntry.selected : [];

                    if (Array.isArray(originalQ.lua_chon) && originalQ.lua_chon.length > 0) {
                        const getCleanContent = (text) => {
                           if (!text) return '';
                           if(originalQ.hasLineMarker) return text.replace(/^\*/, '').trim();
                           return text.replace(optionPrefixRegex, '').replace(/\*/g, '').trim();
                        };
                        
                         if (originalQ.hasLineMarker) {
                             const originalOptionObjects = originalQ.lua_chon.map((opt, index) => ({ text: opt, originalIndex: index }));
                             const shuffledOriginalIndices = shuffledContentIndices.length > 0 ? shuffledContentIndices : originalOptionObjects.map(o => o.originalIndex);
                             
                             shuffledOriginalIndices.forEach(originalContentIndex => {
                                 const originalOptionString = originalOptionObjects[originalContentIndex].text;
                                 const isThisOptionCorrect = originalQ.dap_an_dung.includes(originalOptionString);
                                 const wasThisOptionSelected = userSelectedOptions.includes(originalOptionString);
                                 const color = lightColors[originalContentIndex % lightColors.length];
                                 
                                 let finalStyle = '';
                                 if (wasThisOptionSelected) {
                                     finalStyle = isThisOptionCorrect ? 'color: var(--success-color); font-weight: bold;' : 'color: var(--danger-color);';
                                 } else if (isThisOptionCorrect) {
                                     finalStyle = 'color: var(--success-color); text-decoration: underline;';
                                 } else {
                                     finalStyle = 'color: var(--text-color);';
                                 }
                                 
                                 questionBlockHTML += `<div class="option-item" style="background-color: ${color};"><span style="${finalStyle}">${originalOptionString}</span></div>`;
                             });
                         } else {
                            if (shuffledContentIndices.length > 0) {
                                const originalLabels = originalQ.lua_chon.map(opt => (opt.match(optionPrefixRegex) || [''])[0]);
                                const originalContents = originalQ.lua_chon.map(opt => getCleanContent(opt));

                                originalLabels.forEach((label, newIndex) => {
                                    const originalContentIndex = shuffledContentIndices[newIndex];
                                    if (originalContentIndex === undefined) return;

                                    const originalOptionString = originalQ.lua_chon[originalContentIndex];
                                    const fullShuffledOption = label + originalContents[originalContentIndex];
                                    
                                    const isThisOptionCorrect = originalQ.dap_an_dung.includes(originalOptionString);
                                    const wasThisOptionSelected = userSelectedOptions.includes(fullShuffledOption);
                                    const color = lightColors[originalContentIndex % lightColors.length];
                                    
                                    let finalStyle = '';
                                    if (wasThisOptionSelected) {
                                        finalStyle = isThisOptionCorrect ? 'color: var(--success-color); font-weight: bold;' : 'color: var(--danger-color);';
                                    } else if (isThisOptionCorrect) {
                                        finalStyle = 'color: var(--success-color); text-decoration: underline;';
                                    }
                                    
                                    questionBlockHTML += `<div class="option-item" style="background-color: ${color};"><span style="${finalStyle}">${fullShuffledOption}</span></div>`;
                                });
                            }
                        }
                    } else {
                         questionBlockHTML += `<p class="text-center text-gray-500 p-4">Không có dữ liệu đáp án cho câu này.</p>`;
                    }
                    questionBlockHTML += `</div></div>`;
                }
                
                questionBlock.innerHTML = questionBlockHTML;
                fragment.appendChild(questionBlock);
            });

            comparisonContainer.innerHTML = '';
            comparisonContainer.appendChild(fragment);

            modalTitle.textContent = `So sánh đề gốc và đề đã xáo trộn: ${entry.date}`;
            modal.style.display = 'block';
            document.getElementById('comparison-menu-btn').style.display = 'flex';
            document.getElementById('comparison-help-btn').style.display = 'flex';
        }
        
        function closeComparisonModal() {
            document.getElementById('comparisonModal').style.display = 'none';
            document.getElementById('comparison-menu-btn').style.display = 'none';
            document.getElementById('comparison-help-btn').style.display = 'none'; 
            document.getElementById('helpModal').style.display = 'none'; 
            closeAllMenus();
            clearLargeSearch();
        }

        function initComparisonMenuListeners() {
            const menuBtn = document.getElementById('comparison-menu-btn');
            const smallMenu = document.getElementById('small-search-menu');
            const largeMenu = document.getElementById('large-search-menu');
            const modalContent = document.getElementById('comparisonModalContent');
            let pressTimer = null;

            const startPress = (e) => {
                e.preventDefault();
                pressTimer = setTimeout(() => {
                    closeAllMenus();
                    largeMenu.classList.add('open');
                    modalContent.classList.add('large-search-open');
                    pressTimer = null;
                }, 500);
            };

            const endPress = (e) => {
                e.preventDefault();
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                    if (largeMenu.classList.contains('open')) {
                       closeAllMenus();
                    } else {
                       smallMenu.classList.toggle('open');
                    }
                }
            };
            
            menuBtn.addEventListener('mousedown', startPress);
            menuBtn.addEventListener('mouseup', endPress);
            menuBtn.addEventListener('mouseleave', () => clearTimeout(pressTimer));
            menuBtn.addEventListener('touchstart', startPress, { passive: false });
            menuBtn.addEventListener('touchend', endPress);

            document.getElementById('clear-small-search').addEventListener('click', () => {
                document.getElementById('dao-input').value = '';
                document.getElementById('thuan-input').value = '';
            });
            document.getElementById('exec-small-search').addEventListener('click', execSmallSearch);

            document.getElementById('clear-large-search').addEventListener('click', () => {
                document.getElementById('large-search-input').value = '';
                clearLargeSearch();
            });
            document.getElementById('exec-large-search').addEventListener('click', execLargeSearch);
            document.getElementById('prev-match-btn').addEventListener('click', () => navigateMatches(-1));
            document.getElementById('next-match-btn').addEventListener('click', () => navigateMatches(1));
        }
        
        function closeAllMenus() {
            document.getElementById('small-search-menu').classList.remove('open');
            const largeMenu = document.getElementById('large-search-menu');
            if (largeMenu.classList.contains('open')) {
                largeMenu.classList.remove('open');
                document.getElementById('comparisonModalContent').classList.remove('large-search-open');
            }
        }

        function execSmallSearch() {
            const daoInput = document.getElementById('dao-input');
            const thuanInput = document.getElementById('thuan-input');
            const daoValue = daoInput.value;
            const thuanValue = thuanInput.value;

            if (daoValue && thuanValue) {
                alert('Chỉ nhập 1 dòng thôi!');
                return;
            }

            let targetElement = null;
            if (daoValue) {
                targetElement = document.getElementById(`comp-q-shuffled-${daoValue}`);
            } else if (thuanValue) {
                targetElement = document.querySelector(`.comparison-question[data-original-index='${thuanValue}']`);
            }

            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                targetElement.style.transition = 'background-color 0.5s';
                targetElement.style.backgroundColor = 'rgba(255, 255, 0, 0.3)';
                setTimeout(() => { targetElement.style.backgroundColor = ''; }, 1500);
            } else {
                if(daoValue || thuanValue) alert('Câu không tồn tại!');
            }
        }

        function clearLargeSearch() {
            document.getElementById('large-search-results').textContent = '';
            document.getElementById('prev-match-btn').style.display = 'none';
            document.getElementById('next-match-btn').style.display = 'none';
            largeSearchMatches.forEach(match => {
                if (match.element) {
                   match.element.innerHTML = match.originalHTML;
                }
            });
            largeSearchMatches = [];
            currentMatchIndex = -1;
        }
        
        function execLargeSearch() {
            const searchText = document.getElementById('large-search-input').value.trim();
            const resultsDiv = document.getElementById('large-search-results');
            
            clearLargeSearch();
            
            if (searchText.length < 2) {
                resultsDiv.textContent = 'Vui lòng nhập ít nhất 2 ký tự.';
                return;
            }

            resultsDiv.textContent = 'Đang tìm kiếm...';

            setTimeout(() => {
                const regex = new RegExp(searchText.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
                const allQuestionBlocks = document.querySelectorAll('.comparison-question');
                let totalMatchCount = 0;

                allQuestionBlocks.forEach(qBlock => {
                    if (qBlock.textContent.toLowerCase().includes(searchText.toLowerCase())) {
                        const occurrences = (qBlock.textContent.match(regex) || []).length;
                        
                        if (occurrences > 0) {
                            totalMatchCount += occurrences;
                            const originalHTML = qBlock.innerHTML;
                            const newHTML = qBlock.innerHTML.replace(regex, (match) => `<mark>${match}</mark>`);
                            largeSearchMatches.push({ element: qBlock, originalHTML: originalHTML });
                            qBlock.innerHTML = newHTML;
                        }
                    }
                });
                
                if (largeSearchMatches.length > 0) {
                    resultsDiv.textContent = `Tìm thấy ${totalMatchCount} kết quả trong ${largeSearchMatches.length} câu.`;
                    document.getElementById('prev-match-btn').style.display = 'inline-block';
                    document.getElementById('next-match-btn').style.display = 'inline-block';
                    currentMatchIndex = 0;
                    scrollToMatch(currentMatchIndex);
                } else {
                    resultsDiv.textContent = 'Không tìm thấy kết quả nào.';
                }
            }, 10);
        }
        
        function navigateMatches(direction) {
            if (largeSearchMatches.length === 0) return;
            const newIndex = currentMatchIndex + direction;
            if (newIndex >= 0 && newIndex < largeSearchMatches.length) {
                largeSearchMatches[currentMatchIndex].element.querySelector('mark')?.classList.remove('current-match');
                currentMatchIndex = newIndex;
                scrollToMatch(currentMatchIndex);
            }
        }

        function scrollToMatch(index) {
            const targetElement = largeSearchMatches[index].element;
            const allMarks = document.querySelectorAll('mark.current-match');
            allMarks.forEach(m => m.classList.remove('current-match'));
            
            const firstMarkInElement = targetElement.querySelector('mark');
            if (firstMarkInElement) {
                firstMarkInElement.classList.add('current-match');
            }
            
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function closeHistoryModal() {
            document.getElementById('history-contentModal').style.display = 'none';
        }
        function deleteHistoryFromModal() {
            if (appState.currentModalHistory) {
                deleteHistory(appState.currentModalHistory.id);
            }
        }
        async function deleteHistory(hid) {
            if (confirm(`Bạn có chắc muốn xóa lịch sử này không?`)) {
                let history = await getFromStorage('quizHistory') || [];
                history = history.filter(entry => entry.id != hid);
                await saveToStorage('quizHistory', history);
                closeHistoryModal();
                renderHistoryList();
                document.getElementById('history-questionBox').innerHTML = '';
                document.getElementById('history-questionBox').classList.add("hidden");
                alert('Đã xóa lịch sử!');
            }
        }
        async function exportSelectedQuizzes() {
            if (appState.selectedQuizzes.size === 0) {
                alert('Vui lòng chọn ít nhất một bài thi để xuất!');
                return;
            }
            const savedQuizzes = await getFromStorage('savedQuizzes') || {};
            const exportData = {};
            appState.selectedQuizzes.forEach(quizName => {
                exportData[quizName] = savedQuizzes[quizName];
            });
            downloadJson(exportData, `quiz_export_${new Date().toLocaleDateString('vi-VN').replace(/\//g, '-')}.json`);
            alert('Đã xuất bài thi thành file JSON!');
        }
        async function exportSingleQuiz(qid) {
            const savedQuizzes = await getFromStorage('savedQuizzes') || {};
            const exportData = { [qid]: savedQuizzes[qid] };
            downloadJson(exportData, `quiz_${qid.replace(/\s/g, '_')}.json`);
            alert(`Đã xuất bài thi "${qid}" thành file JSON!`);
        }
        function downloadJson(data, filename){
             const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function importQuiz() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            let quizzesToSave = await getFromStorage('savedQuizzes') || {};
                            let importedCount = 0;
                            let overwrittenCount = 0;

                            for (const name in importedData) {
                                if (quizzesToSave[name]) {
                                    if (confirm(`Bài thi "${name}" đã tồn tại. Bạn có muốn ghi đè không?`)) {
                                        quizzesToSave[name] = importedData[name];
                                        overwrittenCount++;
                                    }
                                } else {
                                    quizzesToSave[name] = importedData[name];
                                    importedCount++;
                                }
                            }
                            await saveToStorage('savedQuizzes', quizzesToSave);
                            alert(`Nhập thành công!\n- ${importedCount} bài mới.\n- ${overwrittenCount} bài được ghi đè.`);
                            if (appState.currentScreen === 'saved-list-screen') {
                                renderSavedQuizzesList();
                            }
                        } catch (err) {
                            console.error(err);
                            alert('Lỗi khi đọc file JSON! File có thể bị lỗi hoặc không đúng định dạng.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        async function clearAllData() {
            if (confirm("⚠️ CẢNH BÁO ⚠️\nBạn có chắc chắn muốn xóa TOÀN BỘ dữ liệu không?\n\nTất cả bài thi đã lưu và lịch sử làm bài sẽ bị xóa vĩnh viễn và KHÔNG THỂ khôi phục.")) {
                try {
                    localStorage.removeItem('savedQuizzes');
                    localStorage.removeItem('quizHistory');
                    localStorage.removeItem(APEX_LIB_KEY);

                    await new Promise((resolve, reject) => {
                        initIndexedDB().then(() => {
                            const transaction = db.transaction(['quizStore'], 'readwrite');
                            const store = transaction.objectStore('quizStore');
                            const request = store.clear();
                            request.onsuccess = () => resolve();
                            request.onerror = (event) => reject(event.target.error);
                        }).catch(reject);
                    });
                    
                    alert('✅ Đã xóa toàn bộ dữ liệu thành công!');
                    location.reload();

                } catch (error) {
                    console.error("Lỗi khi xóa dữ liệu: ", error);
                    alert('Đã xảy ra lỗi trong quá trình xóa dữ liệu. Vui lòng thử lại.');
                }
            }
        }
    </script>
</body>
</html>
